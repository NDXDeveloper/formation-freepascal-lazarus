üîù Retour au [Sommaire](/SOMMAIRE.md)

# 1.4.3 Installation sur macOS et BSD

## Introduction : Les plateformes Unix alternatives

### macOS : L'Unix d'Apple

macOS repr√©sente un cas unique dans l'√©cosyst√®me FreePascal/Lazarus :
- **Base Unix** : Darwin kernel bas√© sur BSD
- **Interface propri√©taire** : Cocoa/AppKit pour les applications natives
- **Architectures multiples** : Intel (x86_64) et Apple Silicon (ARM64/M1/M2/M3)
- **Restrictions** : Gatekeeper, notarisation, sandboxing
- **Outils d√©veloppeur** : Xcode et Command Line Tools requis

### BSD : Les Unix libres

Les syst√®mes BSD (Berkeley Software Distribution) offrent :
- **FreeBSD** : Le plus populaire, excellent support serveur
- **OpenBSD** : Focus sur la s√©curit√©
- **NetBSD** : Portabilit√© maximale
- **DragonFly BSD** : Performance et innovation

Ces syst√®mes partagent des caract√©ristiques communes :
- **Philosophie Unix pure** : "Faire une chose et la faire bien"
- **Syst√®me complet** : Kernel + userland d√©velopp√©s ensemble
- **Ports/Packages** : Syst√®mes de gestion sophistiqu√©s
- **Documentation excellente** : Man pages d√©taill√©es

## Partie 1 : Installation sur macOS

### Pr√©requis macOS

#### Versions support√©es

| Version macOS | Nom | Support Lazarus | Architecture | Notes |
|--------------|-----|-----------------|--------------|-------|
| 14.x | Sonoma | ‚úÖ Excellent | Intel/ARM | Derni√®re version |
| 13.x | Ventura | ‚úÖ Excellent | Intel/ARM | Recommand√© |
| 12.x | Monterey | ‚úÖ Tr√®s bon | Intel/ARM | Stable |
| 11.x | Big Sur | ‚úÖ Bon | Intel/ARM | Premier ARM |
| 10.15 | Catalina | ‚ö†Ô∏è Limit√© | Intel | 64-bit uniquement |
| 10.14 | Mojave | ‚ö†Ô∏è Ancien | Intel | Derni√®re 32-bit |

#### V√©rification du syst√®me

Ouvrez Terminal (Applications ‚Üí Utilitaires ‚Üí Terminal) :

```bash
# Version macOS
sw_vers

# Architecture processeur
uname -m
# arm64 = Apple Silicon (M1/M2/M3)
# x86_64 = Intel

# Espace disque disponible
df -h

# M√©moire
sysctl hw.memsize | awk '{print $2/1073741824 " GB"}'
```

#### Installation de Xcode Command Line Tools

**Indispensable** pour compiler sur macOS :

```bash
# M√©thode 1 : Installation directe
xcode-select --install

# Une fen√™tre appara√Æt, cliquez "Installer"
# T√©l√©chargement ~500MB, installation ~2GB

# M√©thode 2 : Via Xcode complet (App Store)
# T√©l√©charger Xcode depuis l'App Store (plusieurs GB)
# Puis installer les Command Line Tools depuis Xcode

# V√©rifier l'installation
xcode-select -p
# Devrait afficher : /Library/Developer/CommandLineTools
# ou : /Applications/Xcode.app/Contents/Developer

# Accepter la licence
sudo xcodebuild -license accept
```

### M√©thode 1 : Installation avec l'installateur DMG

#### T√©l√©chargement

1. Visitez **https://www.lazarus-ide.org**
2. Choisissez la version pour votre architecture :
   - **Intel Mac** : `lazarus-3.0.0-x86_64-macosx.dmg`
   - **Apple Silicon** : `lazarus-3.0.0-aarch64-macosx.dmg`
   - **Universal** : Fonctionne sur les deux (plus gros)

#### Installation depuis le DMG

```bash
# 1. Monter le DMG (ou double-clic dans Finder)
hdiutil attach lazarus-3.0.0-x86_64-macosx.dmg

# 2. Copier vers Applications
cp -R /Volumes/lazarus/Lazarus.app /Applications/

# 3. Copier FPC et sources (important!)
sudo cp -R /Volumes/lazarus/usr/local/* /usr/local/

# 4. D√©monter le DMG
hdiutil detach /Volumes/lazarus
```

#### Premi√®re ex√©cution et Gatekeeper

macOS bloquera probablement Lazarus au premier lancement :

```bash
# M√©thode 1 : Via Finder
# Clic droit sur Lazarus.app ‚Üí Ouvrir
# Cliquer "Ouvrir" dans la bo√Æte de dialogue

# M√©thode 2 : Terminal (supprime la quarantaine)
xattr -d com.apple.quarantine /Applications/Lazarus.app

# M√©thode 3 : Autoriser globalement (non recommand√©)
sudo spctl --master-disable
```

### M√©thode 2 : Installation via Homebrew

#### Installation de Homebrew

Si Homebrew n'est pas install√© :

```bash
# Installation de Homebrew
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# Pour Apple Silicon, ajouter au PATH
echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zprofile
eval "$(/opt/homebrew/bin/brew shellenv)"

# Pour Intel
echo 'eval "$(/usr/local/bin/brew shellenv)"' >> ~/.zprofile
eval "$(/usr/local/bin/brew shellenv)"

# V√©rifier
brew --version
```

#### Installation de Lazarus avec Homebrew

```bash
# Mise √† jour de Homebrew
brew update

# Rechercher les formules disponibles
brew search lazarus
brew search fpc

# Installation du compilateur FreePascal
brew install fpc

# Installation de Lazarus
brew install --cask lazarus

# V√©rification
fpc -version
lazarus --version
```

#### Gestion avec Homebrew

```bash
# Mise √† jour
brew upgrade fpc
brew upgrade --cask lazarus

# Informations
brew info fpc
brew info --cask lazarus

# D√©sinstallation
brew uninstall fpc
brew uninstall --cask lazarus

# Nettoyage
brew cleanup
```

### M√©thode 3 : Installation via MacPorts

#### Installation de MacPorts

1. T√©l√©chargez MacPorts depuis **https://www.macports.org**
2. Choisissez le package pour votre version macOS
3. Installez le `.pkg`

Ou via Terminal :

```bash
# Apr√®s installation du .pkg
# Mettre √† jour PATH
export PATH="/opt/local/bin:/opt/local/sbin:$PATH"
echo 'export PATH="/opt/local/bin:/opt/local/sbin:$PATH"' >> ~/.zprofile

# Mise √† jour de MacPorts
sudo port selfupdate
```

#### Installation avec MacPorts

```bash
# Rechercher les ports disponibles
port search lazarus
port search fpc

# Installation
sudo port install fpc
sudo port install lazarus

# Variantes disponibles
port variants lazarus

# Installation avec variantes
sudo port install lazarus +gtk2 +universal

# V√©rification
port installed | grep -E "fpc|lazarus"
```

### M√©thode 4 : Compilation depuis les sources sur macOS

#### Pr√©paration

```bash
# Cr√©er structure de r√©pertoires
mkdir -p ~/Development/FreePascal/{fpc,lazarus}
cd ~/Development/FreePascal

# Installer les outils n√©cessaires
brew install svn git wget

# Pour GTK (optionnel, pour cross-platform)
brew install gtk+3 cairo pango
```

#### Compilation de FPC

```bash
# Obtenir FPC de d√©marrage
cd ~/Development/FreePascal
wget https://sourceforge.net/projects/freepascal/files/Mac%20OS%20X/3.2.2/fpc-3.2.2.x86_64-macosx.dmg
hdiutil attach fpc-3.2.2.x86_64-macosx.dmg
sudo installer -pkg /Volumes/fpc-3.2.2/fpc-3.2.2.x86_64-macosx.pkg -target /

# Obtenir les sources
cd fpc
svn checkout https://svn.freepascal.org/svn/fpc/trunk fpc-trunk

# Compiler
cd fpc-trunk
make clean all FPC=/usr/local/bin/fpc

# Installer
sudo make install PREFIX=/usr/local

# V√©rifier
/usr/local/bin/fpc -version
```

#### Compilation de Lazarus

```bash
cd ~/Development/FreePascal/lazarus

# Obtenir les sources
svn checkout https://svn.freepascal.org/svn/lazarus/trunk lazarus-trunk

cd lazarus-trunk

# Compiler pour Cocoa (natif macOS)
make clean all LCL_PLATFORM=cocoa

# Ou pour Carbon (legacy, 32-bit)
# make clean all LCL_PLATFORM=carbon

# Ou pour GTK2 (cross-platform)
# make clean all LCL_PLATFORM=gtk2

# Cr√©er l'application bundle
make app

# Copier vers Applications
cp -R lazarus.app /Applications/Lazarus-Dev.app
```

### Configuration sp√©cifique macOS

#### Signature de code

Pour distribuer vos applications :

```bash
# Voir les identit√©s de signature disponibles
security find-identity -v -p codesigning

# Signer votre application
codesign --force --sign "Developer ID Application: Your Name" YourApp.app

# V√©rifier la signature
codesign --verify --verbose YourApp.app

# Pour la notarisation (requis pour distribution)
xcrun altool --notarize-app \
  --primary-bundle-id "com.yourcompany.yourapp" \
  --username "your@email.com" \
  --password "@keychain:AC_PASSWORD" \
  --file YourApp.dmg
```

#### Configuration des chemins

Ajoutez √† `~/.zprofile` ou `~/.bash_profile` :

```bash
# FreePascal/Lazarus
export FPC_DIR="/usr/local/lib/fpc/3.2.2"
export LAZARUS_DIR="/Applications/Lazarus.app/Contents/MacOS"
export PATH="/usr/local/bin:$PATH"

# Alias utiles
alias lazarus="open -a Lazarus"
alias fpc="/usr/local/bin/fpc"
```

#### Int√©gration avec Finder

Cr√©ez un service Automator pour ouvrir les fichiers `.pas` :

1. Ouvrir Automator
2. Nouveau ‚Üí Service rapide
3. "Le service re√ßoit" ‚Üí fichiers ou dossiers
4. Ajouter "Ex√©cuter un script Shell"
5. Script :
```bash
open -a Lazarus "$@"
```
6. Sauvegarder comme "Ouvrir avec Lazarus"

### Probl√®mes courants sur macOS

#### "Lazarus.app est endommag√©"

```bash
# Supprimer les attributs de quarantaine
xattr -cr /Applications/Lazarus.app

# Ou d√©sactiver temporairement Gatekeeper
sudo spctl --master-disable
# Lancer Lazarus
sudo spctl --master-enable
```

#### Probl√®mes avec les architectures

```bash
# V√©rifier l'architecture d'un binaire
file /Applications/Lazarus.app/Contents/MacOS/lazarus

# Forcer Rosetta 2 pour Intel sur Apple Silicon
arch -x86_64 /Applications/Lazarus.app/Contents/MacOS/lazarus

# Compiler en Universal Binary
make all CPU_TARGET=x86_64
make all CPU_TARGET=aarch64
lipo -create lazarus-x86_64 lazarus-aarch64 -output lazarus-universal
```

## Partie 2 : Installation sur BSD

### FreeBSD

#### Installation via pkg (binaire)

```bash
# Mise √† jour du syst√®me de paquets
sudo pkg update

# Recherche des paquets
pkg search lazarus
pkg search fpc

# Installation
sudo pkg install lazarus fpc

# Installation avec d√©pendances GTK2
sudo pkg install lazarus-gtk2

# Installation avec Qt5
sudo pkg install lazarus-qt5

# V√©rification
pkg info lazarus
fpc -version
```

#### Installation via ports (source)

```bash
# Mise √† jour des ports
sudo portsnap fetch update
# Ou avec Git (FreeBSD 13+)
sudo git -C /usr/ports pull

# Naviguer vers le port
cd /usr/ports/lang/fpc
sudo make config  # Choisir les options
sudo make install clean

cd /usr/ports/editors/lazarus
sudo make config
sudo make install clean

# Options de compilation personnalis√©es
sudo make WITH_GTK2=yes WITH_QT5=yes install clean
```

#### Configuration FreeBSD

```bash
# Ajouter √† ~/.profile ou ~/.bashrc
export PATH="/usr/local/bin:$PATH"
export FPC_DIR="/usr/local/lib/fpc/3.2.2"
export LAZARUS_DIR="/usr/local/share/lazarus"

# Pour X11
export DISPLAY=:0.0

# Permissions pour ports s√©rie
sudo pw groupmod dialer -m $USER
```

### OpenBSD

#### Installation via pkg_add

```bash
# Configuration du miroir
echo "https://cdn.openbsd.org/pub/OpenBSD" > /etc/installurl

# Installation
doas pkg_add lazarus
doas pkg_add fpc

# Avec un miroir sp√©cifique
doas pkg_add -D snap https://mirror.example.org/pub/OpenBSD/7.4/packages/amd64/lazarus-3.0.tgz
```

#### Configuration OpenBSD

```bash
# Limites syst√®me pour compilation
# Ajouter √† /etc/login.conf dans la classe default:
# :datasize-cur=2048M:\
# :datasize-max=infinity:\
# :stacksize-cur=8M:

# Appliquer les changements
doas cap_mkdb /etc/login.conf

# Variables d'environnement
export PATH="/usr/local/bin:$PATH"
export PKG_PATH="https://cdn.openbsd.org/pub/OpenBSD/$(uname -r)/packages/$(arch -s)"
```

### NetBSD

#### Installation via pkgin

```bash
# Installation de pkgin si n√©cessaire
pkg_add pkgin

# Mise √† jour
pkgin update

# Installation
pkgin install lazarus
pkgin install fpc

# Recherche
pkgin search lazarus
```

#### Installation via pkgsrc

```bash
# Obtenir pkgsrc
cd /usr
cvs -q -z3 -d anoncvs@anoncvs.NetBSD.org:/cvsroot checkout -P pkgsrc

# Compiler FPC
cd /usr/pkgsrc/lang/fpc
make install clean

# Compiler Lazarus
cd /usr/pkgsrc/devel/lazarus
make install clean
```

### DragonFly BSD

#### Installation

```bash
# Via pkg
pkg update
pkg install lazarus fpc

# Via dports
cd /usr/dports/lang/fpc
make install clean

cd /usr/dports/editors/lazarus
make install clean
```

## Configuration commune Unix

### Structure des r√©pertoires

```
/usr/local/                    # BSD typique
‚îú‚îÄ‚îÄ bin/
‚îÇ   ‚îú‚îÄ‚îÄ fpc                   # Compilateur
‚îÇ   ‚îú‚îÄ‚îÄ lazarus               # IDE
‚îÇ   ‚îî‚îÄ‚îÄ lazbuild             # Build tool
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îî‚îÄ‚îÄ fpc/                 # Biblioth√®ques FPC
‚îú‚îÄ‚îÄ share/
‚îÇ   ‚îú‚îÄ‚îÄ lazarus/             # Fichiers Lazarus
‚îÇ   ‚îî‚îÄ‚îÄ fpcsrc/              # Sources FPC
‚îî‚îÄ‚îÄ etc/
    ‚îî‚îÄ‚îÄ fpc.cfg              # Configuration FPC

~/.lazarus/                   # Configuration utilisateur
‚îú‚îÄ‚îÄ onlinepackagemanager/
‚îú‚îÄ‚îÄ environmentoptions.xml
‚îî‚îÄ‚îÄ packagefiles.xml
```

### Scripts d'automatisation multi-BSD

#### Script d'installation universel

Cr√©ez `install-lazarus-bsd.sh` :

```bash
#!/bin/sh

# D√©tection du syst√®me BSD
detect_bsd() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        echo $NAME
    elif [ "$(uname -s)" = "FreeBSD" ]; then
        echo "FreeBSD"
    elif [ "$(uname -s)" = "OpenBSD" ]; then
        echo "OpenBSD"
    elif [ "$(uname -s)" = "NetBSD" ]; then
        echo "NetBSD"
    elif [ "$(uname -s)" = "DragonFly" ]; then
        echo "DragonFly"
    else
        echo "Unknown"
    fi
}

BSD_TYPE=$(detect_bsd)
echo "Detected: $BSD_TYPE"

case $BSD_TYPE in
    FreeBSD)
        sudo pkg update
        sudo pkg install -y lazarus fpc
        ;;
    OpenBSD)
        doas pkg_add lazarus fpc
        ;;
    NetBSD)
        pkgin -y install lazarus fpc
        ;;
    DragonFly)
        pkg update
        pkg install -y lazarus fpc
        ;;
    *)
        echo "Syst√®me non support√©"
        exit 1
        ;;
esac

echo "Installation termin√©e!"
```

#### Script de configuration post-installation

Cr√©ez `configure-lazarus-bsd.sh` :

```bash
#!/bin/sh

# Configuration commune BSD

# Cr√©er les r√©pertoires
mkdir -p ~/Projects/Lazarus
mkdir -p ~/.lazarus

# Configuration PATH
echo 'export PATH="/usr/local/bin:$PATH"' >> ~/.profile
echo 'export FPC_DIR="/usr/local/lib/fpc"' >> ~/.profile
echo 'export LAZARUS_DIR="/usr/local/share/lazarus"' >> ~/.profile

# Alias
echo 'alias laz="lazarus"' >> ~/.profile
echo 'alias lazbuild="/usr/local/bin/lazbuild"' >> ~/.profile

# Pour X11
if [ -n "$DISPLAY" ]; then
    echo 'export DISPLAY=:0.0' >> ~/.profile
fi

# Permissions groupes
case $(uname -s) in
    FreeBSD)
        sudo pw groupmod dialer -m $USER
        sudo pw groupmod operator -m $USER
        ;;
    OpenBSD)
        doas usermod -G dialer,operator $USER
        ;;
    NetBSD)
        sudo usermod -G dialer,operator $USER
        ;;
esac

echo "Configuration termin√©e. Reconnectez-vous pour appliquer."
```

## Comparaison macOS vs BSD

### Tableau comparatif

| Aspect | macOS | FreeBSD | OpenBSD | NetBSD |
|--------|-------|---------|---------|--------|
| **Installation** | DMG/Homebrew | pkg/ports | pkg_add | pkgin |
| **Widgetset natif** | Cocoa | GTK2/Qt5 | GTK2 | GTK2/Qt5 |
| **Architecture** | x86_64/ARM64 | x86_64/ARM | x86_64 | Multi |
| **Signature code** | Obligatoire | Non | Non | Non |
| **Sandboxing** | Oui | jail | pledge | Non |
| **Documentation** | Moyenne | Excellente | Excellente | Bonne |
| **Communaut√© FPC** | Moyenne | Bonne | Petite | Petite |
| **Performance** | Excellente | Excellente | Tr√®s bonne | Bonne |

### Choix de plateforme

#### Choisir macOS si :
- ‚úÖ D√©veloppement d'applications Mac natives
- ‚úÖ Besoin de l'√©cosyst√®me Apple
- ‚úÖ Distribution sur App Store
- ‚úÖ Support commercial requis

#### Choisir FreeBSD si :
- ‚úÖ Serveurs et applications syst√®me
- ‚úÖ Performance maximale
- ‚úÖ ZFS et jails n√©cessaires
- ‚úÖ Grande communaut√© BSD

#### Choisir OpenBSD si :
- ‚úÖ S√©curit√© prioritaire absolue
- ‚úÖ Applications critiques
- ‚úÖ Simplicit√© et clart√© du code
- ‚úÖ Documentation exemplaire

#### Choisir NetBSD si :
- ‚úÖ Portabilit√© maximale
- ‚úÖ Syst√®mes embarqu√©s
- ‚úÖ Architectures exotiques
- ‚úÖ Recherche et exp√©rimentation

## D√©veloppement cross-platform macOS/BSD

### Code portable

```pascal
program CrossPlatform;
{$mode objfpc}{$H+}

uses
  {$IFDEF UNIX}
    {$IFDEF DARWIN}
    CocoaAll,  // macOS specific
    {$ELSE}
    Unix,      // BSD/Linux
    {$ENDIF}
  {$ENDIF}
  SysUtils;

begin
  {$IFDEF DARWIN}
  WriteLn('Running on macOS');
  WriteLn('macOS version: ', GetDarwinVersion);
  {$ENDIF}

  {$IFDEF FREEBSD}
  WriteLn('Running on FreeBSD');
  {$ENDIF}

  {$IFDEF OPENBSD}
  WriteLn('Running on OpenBSD');
  {$ENDIF}

  {$IFDEF NETBSD}
  WriteLn('Running on NetBSD');
  {$ENDIF}
end.
```

### Compilation conditionnelle

```pascal
{$IFDEF UNIX}
  {$IFDEF DARWIN}
    // Code sp√©cifique macOS
    {$linkframework Cocoa}
    {$linkframework Carbon}
  {$ELSE}
    // Code BSD/Linux
    {$IFDEF FREEBSD}
      // Sp√©cifique FreeBSD
    {$ENDIF}
  {$ENDIF}
{$ENDIF}
```

## Optimisation et performance

### macOS : Optimisations sp√©cifiques

```bash
# Compilation optimis√©e pour Apple Silicon
make all OPT="-O3 -Cg -XX" CPU_TARGET=aarch64

# Universal Binary
make all CPU_TARGET=x86_64 INSTALL_PREFIX=build-x86_64
make all CPU_TARGET=aarch64 INSTALL_PREFIX=build-aarch64
lipo -create build-x86_64/lazarus build-aarch64/lazarus -output lazarus-universal

# Optimisation avec Link Time Optimization
make all OPT="-O3 -Cg -XX -Xs -flto"
```

### BSD : Optimisations syst√®me

```bash
# FreeBSD : Utiliser clang au lieu de gcc
make all CC=clang CXX=clang++

# OpenBSD : Optimisations s√©curit√©
make all OPT="-O2 -fstack-protector-strong"

# NetBSD : Optimisation multithread
make all OPT="-O3 -pthread"
```

## D√©pannage

### Probl√®mes courants macOS

#### "xcrun: error: invalid active developer path"
```bash
xcode-select --install
sudo xcode-select --switch /Applications/Xcode.app
```

#### "Library not loaded: @rpath/..."
```bash
# V√©rifier les chemins de biblioth√®ques
otool -L /Applications/Lazarus.app/Contents/MacOS/lazarus

# Corriger avec install_name_tool
install_name_tool -add_rpath /usr/local/lib /Applications/Lazarus.app/Contents/MacOS/lazarus
```

### Probl√®mes courants BSD

#### "Cannot find unit interfaces"
```bash
# FreeBSD
export FPCDIR=/usr/local/lib/fpc/3.2.2
export LAZARUSDIR=/usr/local/share/lazarus

# Recompiler la LCL
cd $LAZARUSDIR
gmake clean all
```

#### Probl√®mes X11
```bash
# V√©rifier X11
xhost +
echo $DISPLAY

# FreeBSD : Installer X11
pkg install xorg

# Configuration
echo 'dbus_enable="YES"' >> /etc/rc.conf
echo 'hald_enable="YES"' >> /etc/rc.conf
```

## Conclusion

### Points cl√©s √† retenir

**macOS** :
- N√©cessite Xcode Command Line Tools
- Gatekeeper et signature peuvent compliquer
- Excellente int√©gration native avec Cocoa
- Support ARM64 (Apple Silicon) mature

**BSD** :
- Installation simple via gestionnaires de paquets
- Excellente documentation syst√®me
- Performance et stabilit√© remarquables
- Communaut√© plus petite mais experte

### Ressources sp√©cifiques

**macOS** :
- [macOS Development Guide](https://wiki.lazarus.freepascal.org/Mac_OS_X)
- Forums Apple Developer
- Homebrew community

**BSD** :
- [FreeBSD Handbook](https://docs.freebsd.org/)
- [OpenBSD FAQ](https://www.openbsd.org/faq/)
- Mailing lists BSD sp√©cifiques

### Prochaines √©tapes

1. Configurer l'IDE selon vos pr√©f√©rences
2. Tester la compilation cross-platform
3. Explorer les sp√©cificit√©s de chaque syst√®me
4. Cr√©er votre premier projet portable

L'installation sur macOS et BSD compl√®te votre arsenal multi-plateforme, vous permettant de cr√©er des applications vraiment universelles avec FreePascal/Lazarus.

‚è≠Ô∏è [Configuration avanc√©e du compilateur FPC](/01-introduction-freepascal-lazarus/05-configuration-avancee-compilateur-fpc.md)
