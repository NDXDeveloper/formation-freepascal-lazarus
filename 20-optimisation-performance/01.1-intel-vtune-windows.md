üîù Retour au [Sommaire](/SOMMAIRE.md)

# 20.1.1 Intel VTune (Windows)

## Introduction

Intel VTune Profiler est un outil professionnel de profilage et d'analyse de performance pour les applications Windows. Il permet d'identifier les goulots d'√©tranglement dans votre code FreePascal/Lazarus et d'optimiser les performances de vos applications.

## Qu'est-ce que le profilage ?

Le **profilage** (ou *profiling*) est le processus qui consiste √† mesurer et analyser les performances d'un programme en cours d'ex√©cution. Cela permet de r√©pondre √† des questions comme :

- Quelles fonctions consomment le plus de temps CPU ?
- O√π se trouvent les ralentissements dans mon application ?
- Mon code utilise-t-il efficacement la m√©moire cache ?
- Y a-t-il des sections de code qui pourraient √™tre optimis√©es ?

## Pourquoi utiliser Intel VTune ?

Intel VTune offre plusieurs avantages pour les d√©veloppeurs FreePascal/Lazarus sous Windows :

- **Analyse d√©taill√©e** : Visualisation pr√©cise du temps d'ex√©cution de chaque fonction
- **Profilage au niveau mat√©riel** : Acc√®s aux compteurs de performance du processeur Intel
- **Interface graphique intuitive** : Graphiques et rapports faciles √† comprendre
- **Support multi-threading** : Analyse des applications parall√®les et concurrentes
- **D√©tection de probl√®mes** : Identification automatique des hotspots (points chauds)

## Installation d'Intel VTune sous Windows

### Pr√©requis

- Windows 10 ou Windows 11 (64 bits)
- Processeur Intel (recommand√©, mais fonctionne aussi sur AMD avec fonctionnalit√©s limit√©es)
- Au moins 4 Go de RAM (8 Go recommand√©s)
- Environ 2 Go d'espace disque

### T√©l√©chargement

1. Visitez le site Intel Developer Zone : https://www.intel.com/content/www/us/en/developer/tools/oneapi/vtune-profiler.html
2. T√©l√©chargez la version standalone ou via Intel oneAPI Base Toolkit
3. Intel VTune Profiler est **gratuit** dans sa version standalone

### Installation √©tape par √©tape

1. **Lancez l'installateur** t√©l√©charg√© (`VTune_Installer.exe`)
2. **Acceptez les conditions** de licence Intel
3. **Choisissez le r√©pertoire** d'installation (par d√©faut : `C:\Program Files (x86)\Intel\oneAPI\vtune\`)
4. **S√©lectionnez les composants** :
   - Core Components (obligatoire)
   - Sampling Drivers (recommand√© pour un profilage pr√©cis)
   - .NET Support (optionnel pour FreePascal)
5. **Attendez la fin** de l'installation (5-10 minutes)
6. **Red√©marrez** si demand√© (n√©cessaire pour les drivers)

### Configuration post-installation

Apr√®s l'installation, il est recommand√© de :

1. **V√©rifier les drivers** : VTune installe des drivers syst√®me pour acc√©der aux compteurs mat√©riels
2. **Configurer le pare-feu** : Si vous utilisez le profilage distant
3. **Ajouter au PATH** (optionnel) : Pour utiliser VTune en ligne de commande

```batch
set PATH=%PATH%;C:\Program Files (x86)\Intel\oneAPI\vtune\latest\bin64
```

## Pr√©parer une application FreePascal pour le profilage

### Compilation avec symboles de d√©bogage

Pour que VTune puisse mapper les performances aux lignes de code source, il faut compiler votre projet avec des informations de d√©bogage :

1. **Dans Lazarus IDE** :
   - Allez dans `Project` ‚Üí `Project Options`
   - Section `Compiler Options` ‚Üí `Debugging`
   - Cochez `Generate debug info for GDB (-g)`
   - Dans `Compilation and Linking` : d√©sactivez `Strip symbols` (-Xs)

2. **En ligne de commande** :
```bash
fpc -g -gl monprogramme.pas
```

**Important** : Les symboles de d√©bogage n'affectent pas les performances mesur√©es, seulement la lisibilit√© des r√©sultats.

### Optimisations et profilage

Vous pouvez profiler votre code de deux mani√®res :

**Mode Debug** (recommand√© pour commencer) :
- Facilite l'identification des fonctions
- Les r√©sultats sont plus lisibles
- Mais les temps peuvent √™tre l√©g√®rement diff√©rents de la production

**Mode Release** (pour mesures pr√©cises) :
- Active les optimisations : `-O2` ou `-O3`
- Mesures de performance r√©alistes
- Parfois plus difficile √† analyser (code inline, optimisations)

```bash
# Compilation optimis√©e avec symboles
fpc -O3 -g monprogramme.pas
```

## Lancer Intel VTune

### Interface graphique (GUI)

1. **D√©marrer VTune** :
   - Menu D√©marrer ‚Üí Intel oneAPI ‚Üí Intel VTune Profiler
   - Ou double-clic sur l'ic√¥ne bureau

2. **Cr√©er un nouveau projet** :
   - `File` ‚Üí `New` ‚Üí `Project`
   - Donnez un nom √† votre projet (ex: "MonAppPascal")
   - Choisissez un r√©pertoire pour stocker les r√©sultats

3. **Configurer l'analyse** :
   - Cliquez sur `Configure Analysis`
   - Dans l'onglet `Application`, cliquez sur `Browse` et s√©lectionnez votre `.exe` compil√©
   - Ajoutez les param√®tres de ligne de commande si n√©cessaire
   - D√©finissez le r√©pertoire de travail

### Types d'analyse disponibles

VTune propose plusieurs types d'analyses. Pour d√©buter, voici les plus utiles :

#### 1. **Hotspots Analysis** (Analyse des points chauds)
- **Usage** : Identifier les fonctions qui consomment le plus de temps CPU
- **Quand l'utiliser** : C'est l'analyse de base, commencez toujours par celle-ci
- **Overhead** : Faible (< 5% de ralentissement)

#### 2. **Memory Consumption**
- **Usage** : Analyser l'utilisation de la m√©moire
- **Quand l'utiliser** : Si votre application consomme trop de RAM
- **Overhead** : Mod√©r√©

#### 3. **Threading Analysis**
- **Usage** : Analyser les performances des applications multi-threads
- **Quand l'utiliser** : Pour optimiser la parall√©lisation (voir chapitre 11)
- **Overhead** : Variable

#### 4. **Microarchitecture Exploration**
- **Usage** : Analyse approfondie au niveau CPU (cache misses, branch mispredictions)
- **Quand l'utiliser** : Optimisations avanc√©es uniquement
- **Overhead** : √âlev√©

## Premier profilage : Hotspots Analysis

### Configuration

1. Dans VTune, s√©lectionnez **"Hotspots"** dans la liste des analyses
2. Laissez les param√®tres par d√©faut :
   - Sampling mode : Hardware Event-Based Sampling
   - Sampling interval : Par d√©faut (10ms)
3. Cliquez sur le bouton **Start** (ic√¥ne play ‚ñ∂Ô∏è)

### Ex√©cution

- VTune lance votre application
- Utilisez votre programme normalement (effectuez les op√©rations √† profiler)
- L'analyse se fait en arri√®re-plan
- Fermez l'application quand vous avez termin√© (ou VTune s'arr√™tera automatiquement)

### Lecture des r√©sultats

Apr√®s l'analyse, VTune affiche plusieurs vues :

#### Vue "Summary" (R√©sum√©)

Donne un aper√ßu global :
- **Elapsed Time** : Temps total d'ex√©cution
- **CPU Time** : Temps CPU effectif utilis√©
- **Top Hotspots** : Les 5 fonctions les plus co√ªteuses

#### Vue "Bottom-up" (Vue ascendante)

Liste les fonctions tri√©es par temps CPU d√©croissant :

```
Function Name               | CPU Time  | % of Total
----------------------------|-----------|------------
TMonObjet.CalculComplexe    | 2.450s    | 45.2%
System.Move                 | 0.890s    | 16.4%
TForm1.Button1Click         | 0.650s    | 12.0%
...
```

**Interpr√©tation** :
- Les fonctions en haut de la liste sont vos **hotspots**
- Ce sont elles qu'il faut optimiser en priorit√©
- Double-cliquez sur une fonction pour voir le code source annot√©

#### Vue "Top-down Tree" (Arbre descendant)

Montre la hi√©rarchie d'appels :

```
TForm1.Button1Click (100%)
  ‚îî‚îÄ TMonObjet.CalculComplexe (75%)
      ‚îú‚îÄ System.Move (30%)
      ‚îî‚îÄ TCalculateur.Traiter (45%)
```

**Interpr√©tation** :
- Comprendre le contexte d'appel des fonctions co√ªteuses
- Identifier les chemins critiques

#### Vue "Source" (Code source)

Affiche votre code Pascal avec annotations :

```pascal
procedure TMonObjet.CalculComplexe;
var i: Integer;
begin
  for i := 0 to 1000000 do    // ‚Üê 15% du temps
  begin
    ResultatArray[i] := Sqrt(i) * Sin(i);  // ‚Üê 60% du temps ‚ö†Ô∏è
  end;
end;
```

Les lignes les plus co√ªteuses sont surlign√©es en rouge/orange.

## Interpr√©ter les r√©sultats

### Identifier les hotspots

Un **hotspot** est une fonction ou ligne de code qui consomme une part significative du temps CPU :

- **> 20% du temps total** : Hotspot critique, optimisation prioritaire
- **5-20%** : Hotspot mod√©r√©, √† optimiser selon les besoins
- **< 5%** : Impact faible, optimisation optionnelle

### Comprendre les m√©triques

**CPU Time** :
- Temps pendant lequel le CPU ex√©cute votre code
- N'inclut PAS les temps d'attente I/O

**Wall Clock Time** (Elapsed Time) :
- Temps r√©el √©coul√© du d√©but √† la fin
- Inclut tout (I/O, attentes, etc.)

**Self Time** vs **Total Time** :
- **Self Time** : Temps dans la fonction elle-m√™me (sans les appels)
- **Total Time** : Temps incluant les sous-fonctions appel√©es

### Exemples d'optimisations typiques

#### Exemple 1 : Boucle inefficace

**Avant l'optimisation** :
```pascal
for i := 0 to 1000000 do
  ResultatArray[i] := CalculComplexe(i);  // 80% du temps
```

VTune r√©v√®le que `CalculComplexe` est appel√©e 1 million de fois.

**Apr√®s optimisation** :
```pascal
// Calculer une seule fois et r√©utiliser si possible
ValeurCache := CalculComplexe(0);
for i := 0 to 1000000 do
  ResultatArray[i] := ValeurCache * i;  // 10% du temps
```

#### Exemple 2 : Allocation m√©moire excessive

VTune montre que `System.GetMem` consomme 40% du temps.

**Avant** :
```pascal
for i := 0 to 10000 do
begin
  TempStr := AllouerChaine();  // Allocation √† chaque it√©ration
  // ...
  FreeMem(TempStr);
end;
```

**Apr√®s** :
```pascal
TempStr := AllouerChaine();  // Une seule allocation
for i := 0 to 10000 do
begin
  // R√©utiliser TempStr
end;
FreeMem(TempStr);
```

## Workflow recommand√©

1. **Profiler d'abord** : Mesurez avant d'optimiser (ne pas optimiser pr√©matur√©ment)
2. **Identifier le hotspot #1** : Concentrez-vous sur le plus gros consommateur
3. **Optimiser** : Modifiez le code
4. **Re-profiler** : V√©rifiez que l'optimisation est efficace
5. **R√©p√©ter** : Passez au hotspot suivant

## Commandes en ligne de commande (CLI)

Pour automatiser le profilage, VTune offre une interface CLI :

### Lancer une analyse

```batch
vtune -collect hotspots -result-dir results_001 -- monprogramme.exe
```

### G√©n√©rer un rapport

```batch
vtune -report summary -result-dir results_001
```

### Comparer deux analyses

```batch
vtune -report hotspots -result-dir results_001 -format text -report-output avant.txt
vtune -report hotspots -result-dir results_002 -format text -report-output apres.txt
```

## Limitations et consid√©rations

### Limitations

- **Processeurs Intel recommand√©s** : Certaines analyses n√©cessitent des compteurs Intel
- **Processeurs AMD** : Fonctionnalit√©s limit√©es (pas d'acc√®s aux compteurs sp√©cifiques Intel)
- **Overhead** : VTune ajoute un l√©ger ralentissement (5-10% en mode sampling)
- **Symboles n√©cessaires** : Sans informations de d√©bogage, les r√©sultats sont difficilement exploitables

### Droits administrateur

Certaines analyses (notamment hardware sampling) n√©cessitent des **privil√®ges √©lev√©s** :

- Lancez VTune en tant qu'administrateur (clic droit ‚Üí "Ex√©cuter en tant qu'administrateur")
- Ou configurez les permissions via les param√®tres VTune

### Symboles tiers

Si votre application utilise des DLLs externes, VTune peut ne pas afficher leurs noms de fonctions. Solutions :

- Fournir les fichiers `.pdb` correspondants
- Ou accepter de voir `module.dll+0x1234` (adresse m√©moire)

## Int√©gration avec Lazarus

VTune ne s'int√®gre pas directement dans Lazarus IDE, mais vous pouvez cr√©er un workflow simple :

1. **Compiler** votre projet dans Lazarus (avec `-g`)
2. **Lancer VTune** en externe
3. **Analyser** l'ex√©cutable g√©n√©r√©
4. **Retour dans Lazarus** pour modifier le code
5. **Recompiler et re-profiler**

### Script batch d'automatisation

Cr√©ez un fichier `profile.bat` :

```batch
@echo off
echo Compilation avec symboles...
lazbuild --build-mode=Release MonProjet.lpi

echo Profilage VTune...
vtune -collect hotspots -result-dir results_%DATE:~-4,4%%DATE:~-7,2%%DATE:~-10,2% -- MonProjet.exe

echo G√©n√©ration du rapport...
vtune -report summary -result-dir results_%DATE:~-4,4%%DATE:~-7,2%%DATE:~-10,2% -format text -report-output rapport.txt

echo Termin√© ! Voir rapport.txt
pause
```

## Alternatives √† VTune sous Windows

Si VTune ne convient pas (processeur AMD, licences, etc.), voici des alternatives :

- **Very Sleepy** : Profiler gratuit et simple, id√©al pour d√©buter
- **AMD uProf** : √âquivalent d'AMD pour processeurs Ryzen
- **Windows Performance Analyzer (WPA)** : Outil Microsoft inclus dans Windows SDK
- **Valgrind avec WSL** : Utiliser les outils Linux via Windows Subsystem for Linux

## Ressources compl√©mentaires

### Documentation officielle

- Documentation Intel VTune : https://www.intel.com/content/www/us/en/docs/vtune-profiler/
- Tutoriels vid√©o Intel : https://www.intel.com/content/www/us/en/developer/tools/oneapi/vtune-profiler-videos.html

### Forums et communaut√©

- Forum Intel Developer Zone : https://community.intel.com/t5/Intel-VTune-Profiler/bd-p/vtune
- Lazarus Forum (section Performance) : https://forum.lazarus.freepascal.org/

### Lectures recommand√©es

- "Optimizing Software in C++" par Agner Fog (principes applicables au Pascal)
- Documentation FreePascal sur les optimisations : https://www.freepascal.org/docs.html

## R√©sum√©

Intel VTune Profiler est un outil puissant pour optimiser vos applications FreePascal sous Windows :

‚úÖ **Installation** : Gratuite et simple via Intel oneAPI
‚úÖ **Utilisation** : Interface graphique intuitive pour d√©buter
‚úÖ **R√©sultats** : Identification pr√©cise des hotspots
‚úÖ **Workflow** : Mesurer ‚Üí Optimiser ‚Üí Valider
‚úÖ **Limitations** : Fonctionne mieux sur processeurs Intel

**Prochaine √©tape** : Apr√®s avoir ma√Ætris√© VTune sous Windows, explorez les outils de profilage Linux (section 20.1.2) pour comparer les performances sur diff√©rentes plateformes.

---

*Note : Ce tutoriel fait partie de la formation "FreePascal/Lazarus - Niveau D√©veloppeur Avanc√© - Edition Multi-plateforme Windows/Ubuntu"*

‚è≠Ô∏è [Perf et Valgrind (Linux)](/20-optimisation-performance/01.2-perf-valgrind-linux.md)
