🔝 Retour au [Sommaire](/SOMMAIRE.md)

# 2.5.1 Configuration GDB sur Windows

## Introduction : Le défi GDB sur Windows

Configurer GDB sur Windows peut sembler intimidant au premier abord. Contrairement à Linux où GDB est natif, Windows nécessite quelques étapes supplémentaires. Mais ne vous inquiétez pas ! Ce guide vous accompagnera pas à pas pour obtenir un débogueur parfaitement fonctionnel.

**Pourquoi c'est plus complexe sur Windows ?**
- Windows n'a pas GDB par défaut
- Plusieurs versions de GDB existent (MinGW, Cygwin, MSYS2)
- Les chemins Windows peuvent poser problème
- L'antivirus peut interférer
- Les permissions sont différentes de Linux

## Choisir la bonne version de GDB

### Les différentes distributions

```
Versions GDB pour Windows :
├── MinGW-w64 (Recommandé)
│   ├── Le plus compatible avec Lazarus
│   ├── Support 32 et 64 bits
│   └── Maintenu activement
├── MSYS2
│   ├── Plus récent
│   ├── Gestion de paquets pacman
│   └── Peut être plus complexe
├── Cygwin
│   ├── Émulation Unix complète
│   ├── Plus lourd
│   └── Pas recommandé pour Lazarus
└── TDM-GCC
    ├── Bundle tout-en-un
    ├── Installation simple
    └── Versions parfois anciennes
```

### Version recommandée pour Lazarus

**Pour la majorité des cas : MinGW-w64**

Lazarus inclut généralement une version de GDB avec son installation. Vérifiez d'abord si vous l'avez déjà :

```
C:\lazarus\mingw\x86_64-win64\bin\gdb.exe (64-bit)
C:\lazarus\mingw\i686-win32\bin\gdb.exe (32-bit)
```

## Installation de GDB

### Méthode 1 : GDB inclus avec Lazarus (Recommandé)

Si vous avez installé Lazarus avec l'installateur complet, GDB est déjà présent !

**Vérification :**
1. Ouvrez l'Explorateur Windows
2. Naviguez vers votre dossier Lazarus (généralement `C:\lazarus`)
3. Cherchez le dossier `mingw`
4. Vérifiez la présence de `gdb.exe` dans `bin`

### Méthode 2 : Installation séparée de MinGW-w64

Si GDB n'est pas présent ou si vous voulez une version plus récente :

**Étapes d'installation :**

1. **Télécharger MinGW-w64**
   - Site : https://www.mingw-w64.org/
   - Choisissez : "MingW-W64-builds"
   - Version : Latest
   - Architecture : x86_64 (pour Windows 64-bit)
   - Threads : posix
   - Exception : seh

2. **Installer MinGW-w64**
   ```
   Emplacement suggéré : C:\mingw64
   ├── bin\
   │   ├── gdb.exe
   │   ├── gcc.exe
   │   └── autres outils...
   ├── include\
   └── lib\
   ```

3. **Ajouter au PATH Windows**
   - Clic droit sur "Ce PC" → Propriétés
   - Paramètres système avancés
   - Variables d'environnement
   - Dans "Path", ajouter : `C:\mingw64\bin`

### Méthode 3 : Via MSYS2 (Alternative moderne)

Pour ceux qui veulent la dernière version :

1. **Installer MSYS2**
   - Télécharger depuis : https://www.msys2.org/
   - Installer dans : `C:\msys64`

2. **Installer GDB via pacman**
   ```bash
   # Dans le terminal MSYS2
   pacman -S mingw-w64-x86_64-gdb
   ```

3. **GDB sera dans**
   ```
   C:\msys64\mingw64\bin\gdb.exe
   ```

## Configuration dans Lazarus

### Accéder aux options du débogueur

**Menu : Outils → Options → Débogueur**

```
┌─ Options du Débogueur ─────────────────────────┐
│ Type de débogueur : [GNU debugger (gdb)    ▼] │
│                                                 │
│ Chemin vers gdb:                               │
│ [C:\lazarus\mingw\x86_64-win64\bin\gdb.exe]   │
│ [Parcourir...]                                 │
│                                                 │
│ ☑ Débogueur détecté et fonctionnel ✓          │
└─────────────────────────────────────────────────┘
```

### Configuration de base

#### Onglet "Général"

```
Options générales GDB :
├── Timeout de démarrage : [30] secondes
├── ☑ Arrêter sur les exceptions
├── ☑ Réinitialiser après chaque run
├── ☐ Désactiver LoadSymbolsForLibraries
└── Encodage : [UTF-8]
```

**💡 Conseil** : Augmentez le timeout si vous avez un PC lent ou un gros projet.

#### Onglet "Signals"

Configuration des signaux Windows :

```
Gestion des signaux :
├── SIGSEGV : [Arrêter] (Violations d'accès)
├── SIGFPE : [Arrêter] (Erreurs arithmétiques)
├── SIGILL : [Arrêter] (Instructions illégales)
└── SIGINT : [Ignorer] (Ctrl+C)
```

#### Onglet "OS Specific"

Spécifique à Windows :

```
Options Windows :
├── ☑ Nouveau mode console
├── ☐ Utiliser les commandes Windows
├── ☑ Rediriger la sortie console
└── Type de shell : [cmd.exe]
```

### Test de la configuration

#### Créer un projet de test

```pascal
program TestDebug;
{$mode objfpc}{$H+}

uses
  SysUtils;

var
  i: Integer;
  s: string;

procedure TestProcedure;
begin
  WriteLn('Dans TestProcedure');
  s := 'Test réussi';
end;

begin
  WriteLn('Début du programme');

  for i := 1 to 5 do
  begin
    WriteLn('Itération ', i);
    if i = 3 then
      TestProcedure;
  end;

  WriteLn('Fin du programme');
  WriteLn('Résultat : ', s);
  ReadLn; // Pause pour voir le résultat
end.
```

#### Vérifier le fonctionnement

1. **Placer un point d'arrêt** : Cliquez dans la marge à gauche de `WriteLn('Itération ', i);`
2. **Lancer le débogage** : F9
3. **Si tout fonctionne** : Le programme s'arrête au point d'arrêt
4. **Continuer** : F9 pour reprendre l'exécution

## Problèmes fréquents et solutions

### Problème 1 : "GDB not found"

**Symptôme :**
```
Debugger error
The debugger "C:\path\to\gdb.exe" was not found
```

**Solutions :**
1. Vérifiez que le chemin est correct
2. Assurez-vous que gdb.exe existe à cet emplacement
3. Testez avec le chemin complet sans espaces
4. Essayez avec des guillemets : `"C:\Program Files\gdb\gdb.exe"`

### Problème 2 : "Cannot create process"

**Symptôme :**
```
The GDB command:
"-gdb-set confirm off"
returned the error:
"Cannot create process"
```

**Solutions :**
1. **Antivirus** : Ajoutez gdb.exe aux exclusions
2. **Permissions** : Lancez Lazarus en administrateur
3. **PATH** : Vérifiez que le dossier bin est dans PATH
4. **Compatibilité** : Propriétés de gdb.exe → Compatibilité → Windows 7

### Problème 3 : Symboles de débogage manquants

**Symptôme :**
```
No symbol table is loaded
Use the "file" command
```

**Solution - Configuration du projet :**
```
Projet → Options du projet → Compilation et édition de liens
├── ☑ Générer infos de débogage (-g)
├── Type : [Dwarf with sets (-gw -godwarfsets)]
├── ☑ Afficher numéros de ligne (-gl)
├── ☑ Utiliser symboles externes (-Xg)
└── ☐ Strip symbols (-Xs) - DOIT ÊTRE DÉCOCHÉ !
```

### Problème 4 : Caractères spéciaux et chemins

**Symptôme :** Erreurs avec des chemins contenant des espaces ou accents

**Solutions :**

1. **Évitez les caractères spéciaux** dans :
   - Le chemin d'installation de Lazarus
   - Le chemin de vos projets
   - Les noms de fichiers

2. **Utilisez des chemins courts** :
   ```
   Mauvais : C:\Mes Documents\Développement Pascal\Mon Super Projet\
   Bon : C:\Dev\Projects\MyProject\
   ```

3. **Format 8.3** (dernier recours) :
   ```cmd
   # Pour obtenir le nom court
   dir /x "C:\Program Files"
   # Résultat : PROGRA~1
   ```

### Problème 5 : Windows Defender bloque GDB

**Symptôme :** GDB très lent ou bloqué

**Solution complète :**

1. **Exclusions Windows Defender**
   - Paramètres → Mise à jour et sécurité
   - Sécurité Windows → Protection contre les virus
   - Gérer les paramètres → Exclusions
   - Ajouter :
     ```
     C:\lazarus\
     C:\mingw64\
     %TEMP%\
     Vos dossiers de projets
     ```

2. **Exclusions de processus**
   - Ajouter les processus :
     ```
     gdb.exe
     lazarus.exe
     fpc.exe
     votre_programme.exe
     ```

## Configuration avancée

### Optimiser les performances

#### Désactiver les fonctionnalités inutiles

```
Options → Débogueur → Général :
├── ☐ Charger symboles pour toutes les DLL
├── ☐ Mode verbose
├── ☑ Cache des symboles
└── Taille du cache : [100] MB
```

#### Configuration pour gros projets

```
Ajustements pour projets volumineux :
├── Timeout : [60] secondes
├── Max string length : [10000]
├── Max array length : [1000]
└── Max depth : [50]
```

### Scripts GDB personnalisés

Créez un fichier `.gdbinit` dans votre dossier projet :

```gdb
# .gdbinit - Configuration personnalisée GDB
set print pretty on
set print array on
set print array-indexes on
set charset UTF-8
set breakpoint pending on
set confirm off

# Commandes personnalisées
define showpascalstring
  print (char*)$arg0+1@byte[$arg0[0]]
end
```

### Débogage 32-bit vs 64-bit

#### Configuration double architecture

```
Configuration multi-architecture :
├── Projet 32-bit → GDB 32-bit
│   └── C:\lazarus\mingw\i686-win32\bin\gdb.exe
└── Projet 64-bit → GDB 64-bit
    └── C:\lazarus\mingw\x86_64-win64\bin\gdb.exe
```

**⚠️ Important** : Utilisez toujours le GDB correspondant à votre architecture cible !

### Mode de compatibilité

Pour les anciens projets ou cas spéciaux :

```
Options → Débogueur → Compatibilité :
├── ☑ Mode compatibilité Delphi
├── ☐ Désactiver FPC extensions
├── ☑ Auto SOLIB add
└── Version GDB minimale : [7.0]
```

## Intégration avec l'environnement Windows

### Console Windows

#### Affichage de la console

```
Options du projet → Options de compilation → Config et cible :
├── ☑ Application Win32 GUI (-WG)
│   └── Pas de console par défaut
└── ☐ Application Win32 GUI (-WG)
    └── Console visible pour WriteLn
```

Pour voir les `WriteLn` en mode GUI :
```pascal
{$APPTYPE CONSOLE}  // Force la console
// ou
AllocConsole;       // Crée une console dynamiquement
```

### Débogage de services Windows

Configuration spéciale pour les services :

1. **Attacher au processus**
   - Run → Attach to process
   - Sélectionner votre service
   - Nécessite les privilèges admin

2. **Simuler le service**
   ```pascal
   {$IFDEF DEBUG}
     // Mode debug : application normale
     Application.Run;
   {$ELSE}
     // Mode release : service Windows
     ServiceApplication.Run;
   {$ENDIF}
   ```

## Outils complémentaires

### GDB GUI alternatives

Si l'interface de Lazarus ne suffit pas :

```
Interfaces graphiques pour GDB :
├── GDBgui (Web-based)
│   └── pip install gdbgui
├── QtCreator
│   └── Peut déboguer des exe Pascal
└── Visual Studio Code
    └── Avec extension Native Debug
```

### Debugging Tools for Windows

Outils Microsoft complémentaires :

1. **WinDbg** : Débogueur système Windows
2. **Application Verifier** : Détection de bugs
3. **ProcMon** : Surveillance des processus
4. **DebugView** : Capture OutputDebugString

### Logging amélioré

Pour compléter le débogage :

```pascal
uses
  Windows;

procedure DebugLog(const Msg: string);
begin
  {$IFDEF DEBUG}
  OutputDebugString(PChar(FormatDateTime('hh:nn:ss.zzz ', Now) + Msg));
  {$ENDIF}
end;
```

Visualisez avec DebugView++ (gratuit).

## Bonnes pratiques Windows

### Organisation des fichiers

```
Structure recommandée :
MonProjet\
├── bin\
│   ├── Win32\
│   │   ├── Debug\
│   │   └── Release\
│   └── Win64\
│       ├── Debug\
│       └── Release\
├── src\
├── lib\
└── .gdbinit
```

### Configuration par mode de build

#### Mode Debug
```ini
# project.lpi - Mode Debug
-g     # Symboles de debug
-gl    # Numéros de ligne
-gw3   # Format Dwarf 3
-godwarfsets # Types set
-gh    # Heaptrc
-Ci    # IO checks
-Co    # Overflow checks
-Cr    # Range checks
-Sa    # Assertions
```

#### Mode Release
```ini
# project.lpi - Mode Release
-O3    # Optimisation max
-Xs    # Strip symbols
-XX    # Smart linking
#-g    # PAS de symboles
```

### Automatisation avec batch

Créez `debug.bat` pour lancer en mode debug :

```batch
@echo off
set LAZARUS_DIR=C:\lazarus
set PROJECT_NAME=MonProjet

echo Compilation en mode DEBUG...
%LAZARUS_DIR%\lazbuild.exe --build-mode=Debug %PROJECT_NAME%.lpi

if %ERRORLEVEL% == 0 (
    echo Lancement avec GDB...
    %LAZARUS_DIR%\mingw\x86_64-win64\bin\gdb.exe bin\Win64\Debug\%PROJECT_NAME%.exe
) else (
    echo Erreur de compilation!
    pause
)
```

## Checklist de vérification

Avant de commencer à déboguer, vérifiez :

```
☐ GDB est installé et accessible
☐ Le chemin vers GDB est configuré dans Lazarus
☐ Les symboles de debug sont activés (-g)
☐ L'optimisation est désactivée en debug (-O-)
☐ L'antivirus a des exclusions pour GDB
☐ Les chemins ne contiennent pas d'espaces/accents
☐ Le projet compile sans erreurs
☐ Les permissions sont suffisantes
☐ La bonne architecture est sélectionnée (32/64)
☐ Le mode de build est "Debug"
```

## Tester votre configuration

### Test simple

```pascal
program TestGDB;
begin
  WriteLn('Si vous voyez ceci dans le débogueur,');
  WriteLn('GDB fonctionne correctement!');
  ReadLn;
end.
```

1. Mettez un point d'arrêt sur le premier `WriteLn`
2. Lancez avec F9
3. Si le programme s'arrête → ✅ Succès !

### Test avancé

```pascal
program TestGDBAdvanced;
uses SysUtils, Classes;

type
  TTestClass = class
  private
    FValue: Integer;
  public
    constructor Create(AValue: Integer);
    property Value: Integer read FValue write FValue;
  end;

constructor TTestClass.Create(AValue: Integer);
begin
  FValue := AValue;  // Point d'arrêt ici
end;

var
  Test: TTestClass;
  List: TStringList;
  i: Integer;

begin
  Test := TTestClass.Create(42);
  List := TStringList.Create;
  try
    for i := 1 to 10 do
      List.Add(Format('Item %d', [i]));

    WriteLn('Test.Value = ', Test.Value);
    WriteLn('List.Count = ', List.Count);

    // Testez l'inspection des variables ici
    ReadLn;
  finally
    List.Free;
    Test.Free;
  end;
end.
```

Si vous pouvez :
- Voir la valeur de `FValue` dans le constructeur
- Inspecter le contenu de `List`
- Naviguer dans la pile d'appels

→ Votre configuration est parfaite ! 🎉

## Conclusion

La configuration de GDB sur Windows demande un peu de patience, mais une fois en place, vous disposez d'un outil de débogage extrêmement puissant. Les problèmes initiaux sont généralement liés aux chemins, aux permissions ou à l'antivirus. Une fois ces obstacles franchis, GDB sur Windows est aussi efficace que sur Linux.

**Points clés à retenir :**
- Utilisez de préférence le GDB fourni avec Lazarus
- Évitez les espaces et caractères spéciaux dans les chemins
- Configurez les exclusions antivirus
- Utilisez la bonne architecture (32/64 bits)
- Activez toujours les symboles de debug en développement

Dans la section suivante (2.5.2), nous verrons la configuration sur Ubuntu/Linux, qui est généralement plus simple mais offre des possibilités supplémentaires.

⏭️
