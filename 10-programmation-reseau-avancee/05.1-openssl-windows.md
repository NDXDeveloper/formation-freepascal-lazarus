üîù Retour au [Sommaire](/SOMMAIRE.md)

# 10.5.1 OpenSSL sur Windows

## Introduction

OpenSSL est la biblioth√®que cryptographique open-source la plus utilis√©e pour impl√©menter SSL/TLS. Sur Windows, son installation et sa configuration n√©cessitent quelques √©tapes sp√©cifiques, car contrairement √† Linux, Windows n'inclut pas OpenSSL par d√©faut.

Dans cette section, nous allons apprendre √† :
- Installer OpenSSL sur Windows
- Configurer les biblioth√®ques pour FreePascal/Lazarus
- V√©rifier l'installation
- Utiliser OpenSSL dans nos programmes

## Pourquoi OpenSSL sur Windows ?

**Avantages :**
- ‚úÖ Standard de l'industrie
- ‚úÖ Support complet de SSL/TLS
- ‚úÖ Gratuit et open-source
- ‚úÖ Compatible avec FreePascal/Lazarus
- ‚úÖ M√™me code sur Windows et Linux

**Alternatives Windows :**
- SChannel (API native Windows) - Plus complexe
- WinSSL - Limit√©
- OpenSSL reste le meilleur choix pour la portabilit√©

## Versions d'OpenSSL

### Versions disponibles

```
OpenSSL 1.0.2 ‚Üí ‚ùå Obsol√®te (fin de support 2019)
OpenSSL 1.1.0 ‚Üí ‚ùå Obsol√®te (fin de support 2019)
OpenSSL 1.1.1 ‚Üí ‚ö†Ô∏è  LTS (support jusqu'en septembre 2023)
OpenSSL 3.0.x ‚Üí ‚úÖ Actuel (support jusqu'en septembre 2026)
OpenSSL 3.1.x ‚Üí ‚úÖ Actuel (support jusqu'en mars 2025)
```

**Recommandation :** Utilisez OpenSSL 3.0+ pour les nouveaux projets, ou au minimum 1.1.1 pour la compatibilit√©.

### Fichiers DLL selon la version

**OpenSSL 1.1.1 :**
```
libssl-1_1.dll       (ou ssleay32.dll)
libcrypto-1_1.dll    (ou libeay32.dll)
```

**OpenSSL 3.0+ :**
```
libssl-3.dll
libcrypto-3.dll
```

## Installation d'OpenSSL

### M√©thode 1 : Installation binaire (Recommand√©e)

#### Option A : Slproweb (la plus populaire)

1. **T√©l√©chargement**
   - Allez sur : https://slproweb.com/products/Win32OpenSSL.html
   - Choisissez la version appropri√©e :
     - **Win64 OpenSSL v3.x.x** pour syst√®me 64 bits (recommand√©)
     - **Win32 OpenSSL v3.x.x** pour syst√®me 32 bits (rare aujourd'hui)

2. **Types d'installateur**
   ```
   Win64 OpenSSL v3.x.x (exe, ~6 MB)
   ‚îú‚îÄ Version compl√®te avec fichiers de d√©veloppement
   ‚îî‚îÄ Recommand√© pour le d√©veloppement

   Win64 OpenSSL v3.x.x Light (exe, ~2 MB)
   ‚îú‚îÄ Version all√©g√©e, DLLs uniquement
   ‚îî‚îÄ Suffisant pour ex√©cuter des applications
   ```

3. **Installation**

   Lancez l'installateur :

   ```
   Installation OpenSSL
   ‚îú‚îÄ Chemin d'installation par d√©faut :
   ‚îÇ  C:\Program Files\OpenSSL-Win64\
   ‚îÇ
   ‚îú‚îÄ Options importantes :
   ‚îÇ  ‚òë Installer les DLLs dans le dossier OpenSSL
   ‚îÇ  ‚òë Copier les DLLs dans le dossier System (optionnel)
   ‚îÇ
   ‚îî‚îÄ Terminer l'installation
   ```

4. **V√©rification**

   Ouvrez PowerShell ou CMD :

   ```cmd
   cd "C:\Program Files\OpenSSL-Win64\bin"
   openssl version
   ```

   R√©sultat attendu :
   ```
   OpenSSL 3.2.0 23 Nov 2023 (Library: OpenSSL 3.2.0 23 Nov 2023)
   ```

#### Option B : Chocolatey (gestionnaire de paquets)

Si vous utilisez Chocolatey :

```powershell
# En tant qu'administrateur
choco install openssl

# V√©rification
openssl version
```

### M√©thode 2 : Binaires portables

Pour une version portable sans installation :

1. T√©l√©chargez depuis : https://curl.se/windows/
2. Ou depuis : https://indy.fulgan.com/SSL/
3. Extrayez les DLLs dans votre dossier de projet

**Structure recommand√©e :**
```
MonProjet\
‚îú‚îÄ MonProjet.lpr
‚îú‚îÄ ssl\
‚îÇ  ‚îú‚îÄ libssl-3.dll
‚îÇ  ‚îî‚îÄ libcrypto-3.dll
‚îî‚îÄ bin\
   ‚îî‚îÄ MonProjet.exe
```

## Configuration pour FreePascal/Lazarus

### Emplacement des DLLs

Trois options pour que votre application trouve les DLLs :

#### Option 1 : Dans le dossier de l'ex√©cutable (Recommand√©)

```
MonProjet\
‚îú‚îÄ MonProjet.exe
‚îú‚îÄ libssl-3.dll
‚îî‚îÄ libcrypto-3.dll
```

**Avantages :**
- ‚úÖ Pas de d√©pendance syst√®me
- ‚úÖ Version sp√©cifique garantie
- ‚úÖ Portable

#### Option 2 : Dans le PATH syst√®me

Ajoutez le dossier OpenSSL au PATH :

```powershell
# PowerShell (Administrateur)
$env:Path += ";C:\Program Files\OpenSSL-Win64\bin"

# Pour rendre permanent :
[Environment]::SetEnvironmentVariable(
    "Path",
    [Environment]::GetEnvironmentVariable("Path", "Machine") + ";C:\Program Files\OpenSSL-Win64\bin",
    "Machine"
)
```

Ou via l'interface graphique :
```
Panneau de configuration
‚Üí Syst√®me
‚Üí Param√®tres syst√®me avanc√©s
‚Üí Variables d'environnement
‚Üí Path
‚Üí Ajouter : C:\Program Files\OpenSSL-Win64\bin
```

#### Option 3 : Dans System32 (Non recommand√©)

Copier les DLLs dans `C:\Windows\System32\` fonctionne mais n'est pas recommand√© :
- ‚ùå Conflit potentiel avec d'autres versions
- ‚ùå N√©cessite les droits administrateur
- ‚ùå Difficile √† mettre √† jour

### Configuration dans votre code FreePascal

#### D√©finir les chemins des DLLs

```pascal
{$mode objfpc}{$H+}

uses
  SysUtils;

const
  {$IFDEF WINDOWS}
    {$IFDEF CPU64}
    // OpenSSL 3.0+
    DLLSSLName = 'libssl-3.dll';
    DLLCryptoName = 'libcrypto-3.dll';

    // Ou pour OpenSSL 1.1.1
    // DLLSSLName = 'libssl-1_1-x64.dll';
    // DLLCryptoName = 'libcrypto-1_1-x64.dll';
    {$ELSE}
    // 32 bits
    DLLSSLName = 'libssl-3.dll';
    DLLCryptoName = 'libcrypto-3.dll';
    {$ENDIF}
  {$ENDIF}
```

#### Utilisation avec Synapse

```pascal
program TestSSLSynapse;

{$mode objfpc}{$H+}

uses
  SysUtils, Classes,
  httpsend,    // Client HTTP de Synapse
  ssl_openssl; // Support SSL

var
  HTTP: THTTPSend;
begin
  HTTP := THTTPSend.Create;
  try
    WriteLn('Test de connexion HTTPS...');

    if HTTP.HTTPMethod('GET', 'https://www.google.com') then
    begin
      WriteLn('Succ√®s ! Code: ', HTTP.ResultCode);
      WriteLn('Taille de la r√©ponse: ', HTTP.Document.Size, ' octets');
    end
    else
      WriteLn('√âchec de la connexion');

  finally
    HTTP.Free;
  end;

  WriteLn;
  WriteLn('Appuyez sur Entr√©e...');
  ReadLn;
end.
```

#### Utilisation avec Indy

```pascal
program TestSSLIndy;

{$mode objfpc}{$H+}

uses
  SysUtils, Classes,
  IdHTTP,
  IdSSLOpenSSL;

var
  HTTP: TIdHTTP;
  SSLHandler: TIdSSLIOHandlerSocketOpenSSL;
begin
  HTTP := TIdHTTP.Create(nil);
  SSLHandler := TIdSSLIOHandlerSocketOpenSSL.Create(nil);

  try
    // Configuration SSL
    SSLHandler.SSLOptions.Method := sslvTLSv1_2;
    SSLHandler.SSLOptions.Mode := sslmClient;

    HTTP.IOHandler := SSLHandler;

    WriteLn('Test de connexion HTTPS avec Indy...');

    try
      var Response := HTTP.Get('https://www.google.com');
      WriteLn('Succ√®s !');
      WriteLn('Taille: ', Length(Response), ' caract√®res');
    except
      on E: Exception do
        WriteLn('Erreur: ', E.Message);
    end;

  finally
    SSLHandler.Free;
    HTTP.Free;
  end;

  WriteLn;
  WriteLn('Appuyez sur Entr√©e...');
  ReadLn;
end.
```

## V√©rification de l'installation

### Test 1 : Commande OpenSSL

```cmd
cd "C:\Program Files\OpenSSL-Win64\bin"

# Version
openssl version

# Test de g√©n√©ration de nombres al√©atoires
openssl rand -hex 16

# Liste des algorithmes disponibles
openssl list -cipher-algorithms

# Liste des protocoles SSL/TLS
openssl s_client -help
```

### Test 2 : V√©rification des DLLs

Programme FreePascal pour tester le chargement :

```pascal
program TestOpenSSLDLLs;

{$mode objfpc}{$H+}

uses
  Windows, SysUtils;

function TestLoadDLL(const DLLName: string): Boolean;
var
  Handle: THandle;
begin
  Result := False;

  WriteLn('Test de chargement : ', DLLName);

  Handle := LoadLibrary(PChar(DLLName));

  if Handle <> 0 then
  begin
    WriteLn('  ‚úì DLL charg√©e avec succ√®s');
    WriteLn('  Handle: ', Handle);
    FreeLibrary(Handle);
    Result := True;
  end
  else
  begin
    WriteLn('  ‚úó Impossible de charger la DLL');
    WriteLn('  Erreur: ', GetLastError);
  end;

  WriteLn;
end;

begin
  WriteLn('=== Test de chargement des DLLs OpenSSL ===');
  WriteLn;

  if TestLoadDLL('libssl-3.dll') and TestLoadDLL('libcrypto-3.dll') then
    WriteLn('‚úì OpenSSL est correctement install√© !')
  else
    WriteLn('‚úó Probl√®me avec l''installation OpenSSL');

  WriteLn;
  WriteLn('Appuyez sur Entr√©e...');
  ReadLn;
end.
```

### Test 3 : Connexion HTTPS r√©elle

```pascal
program TestHTTPS;

{$mode objfpc}{$H+}

uses
  SysUtils, httpsend, ssl_openssl;

function TestHTTPSConnection(const URL: string): Boolean;
var
  HTTP: THTTPSend;
begin
  Result := False;

  WriteLn('Test de connexion √† : ', URL);

  HTTP := THTTPSend.Create;
  try
    if HTTP.HTTPMethod('GET', URL) then
    begin
      WriteLn('  ‚úì Connexion r√©ussie');
      WriteLn('  Code HTTP: ', HTTP.ResultCode);
      WriteLn('  Taille: ', HTTP.Document.Size, ' octets');
      Result := True;
    end
    else
      WriteLn('  ‚úó Connexion √©chou√©e');

  finally
    HTTP.Free;
  end;

  WriteLn;
end;

begin
  WriteLn('=== Test de connexions HTTPS ===');
  WriteLn;

  TestHTTPSConnection('https://www.google.com');
  TestHTTPSConnection('https://github.com');
  TestHTTPSConnection('https://www.wikipedia.org');

  WriteLn('Tests termin√©s');
  WriteLn;
  WriteLn('Appuyez sur Entr√©e...');
  ReadLn;
end.
```

## R√©solution de probl√®mes courants

### Erreur : "Impossible de charger libssl-3.dll"

**Causes possibles :**

1. **DLL introuvable**
   ```
   Solution : Copiez les DLLs dans le dossier de l'ex√©cutable
   ```

2. **Mauvaise version (32 vs 64 bits)**
   ```pascal
   // V√©rifiez votre cible de compilation
   {$IFDEF CPU64}
   WriteLn('Application 64 bits - Utilisez libssl-3-x64.dll');
   {$ELSE}
   WriteLn('Application 32 bits - Utilisez libssl-3.dll (32 bits)');
   {$ENDIF}
   ```

3. **D√©pendances manquantes**
   ```
   Solution : Installez Visual C++ Redistributable
   T√©l√©chargez depuis : https://aka.ms/vs/17/release/vc_redist.x64.exe
   ```

### Erreur : "The ordinal 3 could not be located"

**Cause :** Conflit de versions de DLL

**Solution :**
```cmd
# Trouver toutes les instances de libssl
where /R C:\ libssl-3.dll

# Supprimez les anciennes versions et gardez seulement celle dans votre projet
```

### Erreur : "SSL handshake failed"

**Cause :** Protocoles SSL/TLS obsol√®tes

**Solution :**
```pascal
// Forcer TLS 1.2 ou sup√©rieur
HTTP.Sock.SSL.SSLType := LT_TLSv1_2;

// Ou avec Indy
SSLHandler.SSLOptions.Method := sslvTLSv1_2;
```

### Erreur : "Certificate verify failed"

**Cause :** Certificats racine manquants

**Solution :**
```pascal
// T√©l√©charger le bundle de certificats
// https://curl.se/ca/cacert.pem

// Puis configurer :
HTTP.Sock.SSL.CertCAFile := 'cacert.pem';
```

## G√©n√©ration de certificats de test

### Certificat auto-sign√© pour d√©veloppement

```cmd
cd "C:\Program Files\OpenSSL-Win64\bin"

# G√©n√©ration d'une cl√© priv√©e et d'un certificat
openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes

# R√©pondez aux questions :
Country Name (2 letter code) []:FR
State or Province Name []:Ile-de-France
Locality Name []:Paris
Organization Name []:MonEntreprise
Organizational Unit Name []:IT
Common Name []:localhost
Email Address []:admin@localhost
```

**Fichiers g√©n√©r√©s :**
- `key.pem` : Cl√© priv√©e (√† garder SECRET)
- `cert.pem` : Certificat public

### Conversion en format PKCS#12

Pour certaines applications :

```cmd
openssl pkcs12 -export -out certificate.pfx -inkey key.pem -in cert.pem
```

## Configuration avanc√©e

### Variables d'environnement OpenSSL

```cmd
# Configuration du chemin de recherche des certificats
set SSL_CERT_FILE=C:\chemin\vers\cacert.pem
set SSL_CERT_DIR=C:\chemin\vers\certs\

# Configuration du fichier de configuration OpenSSL
set OPENSSL_CONF=C:\Program Files\OpenSSL-Win64\openssl.cfg
```

### Fichier de configuration OpenSSL (openssl.cfg)

Cr√©ez un fichier `openssl.cfg` dans votre projet :

```ini
[openssl_init]
providers = provider_sect

[provider_sect]
default = default_sect
legacy = legacy_sect

[default_sect]
activate = 1

[legacy_sect]
activate = 1
```

Chargez-le dans votre programme :

```pascal
SetEnvironmentVariable('OPENSSL_CONF', 'openssl.cfg');
```

## Bonnes pratiques

### Checklist de d√©ploiement

‚úÖ **Pour le d√©veloppement :**
- Installer OpenSSL avec l'installateur Slproweb
- Ajouter au PATH pour faciliter les tests
- Utiliser des certificats auto-sign√©s

‚úÖ **Pour la distribution :**
- Inclure les DLLs OpenSSL dans le dossier de l'application
- Tester sur une machine propre (sans OpenSSL install√©)
- Documenter la version d'OpenSSL utilis√©e
- Inclure le bundle de certificats racine si n√©cessaire

‚úÖ **Pour la s√©curit√© :**
- Utiliser OpenSSL 3.0+ ou au minimum 1.1.1
- Activer uniquement TLS 1.2 et TLS 1.3
- Valider les certificats serveur
- Ne jamais d√©sactiver la v√©rification SSL en production

### Structure de projet recommand√©e

```
MonProjet\
‚îú‚îÄ src\
‚îÇ  ‚îú‚îÄ MonProjet.lpr
‚îÇ  ‚îî‚îÄ units\
‚îú‚îÄ ssl\
‚îÇ  ‚îú‚îÄ libssl-3.dll
‚îÇ  ‚îú‚îÄ libcrypto-3.dll
‚îÇ  ‚îî‚îÄ cacert.pem
‚îú‚îÄ bin\
‚îÇ  ‚îî‚îÄ (ex√©cutables compil√©s)
‚îî‚îÄ README.md
```

### Script de d√©ploiement

Cr√©ez un fichier `deploy.bat` :

```batch
@echo off
echo === D√©ploiement de l'application ===

rem Compilation
lazbuild --build-mode=Release MonProjet.lpr

rem Copie des DLLs SSL
copy ssl\*.dll bin\

rem Copie des certificats
copy ssl\cacert.pem bin\

rem Cr√©ation de l'archive
cd bin
7z a ..\MonProjet-Release.zip *
cd ..

echo D√©ploiement termin√© !
pause
```

## Mise √† jour d'OpenSSL

### V√©rifier la version install√©e

```pascal
program CheckOpenSSLVersion;

{$mode objfpc}{$H+}

uses
  SysUtils, ssl_openssl;

begin
  WriteLn('Version d''OpenSSL d√©tect√©e :');
  WriteLn(SSLImplementation.OpenSSLVersion);
  WriteLn;
  WriteLn('Appuyez sur Entr√©e...');
  ReadLn;
end.
```

### Proc√©dure de mise √† jour

1. **T√©l√©charger la nouvelle version** depuis Slproweb
2. **D√©sinstaller l'ancienne version** (optionnel)
3. **Installer la nouvelle version**
4. **Tester vos applications**
5. **Mettre √† jour les DLLs distribu√©es**

**Note :** OpenSSL 3.x est compatible avec le code √©crit pour 1.1.1, mais les noms de DLL changent.

## R√©sum√©

### Points cl√©s √† retenir

‚úÖ **Installation** : Utilisez l'installateur Slproweb pour Windows
‚úÖ **DLLs** : `libssl-3.dll` et `libcrypto-3.dll` pour OpenSSL 3.x
‚úÖ **Emplacement** : Mettez les DLLs dans le dossier de l'ex√©cutable
‚úÖ **Version** : Utilisez OpenSSL 3.0+ ou minimum 1.1.1
‚úÖ **Tests** : V√©rifiez toujours avec une connexion HTTPS r√©elle
‚úÖ **Distribution** : Incluez les DLLs avec votre application

### Commandes essentielles

```cmd
# V√©rifier la version
openssl version

# G√©n√©rer un certificat de test
openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -days 365 -nodes

# Tester une connexion SSL
openssl s_client -connect google.com:443

# Voir le certificat d'un site
openssl s_client -connect google.com:443 -showcerts
```

### Ressources

- **Site officiel OpenSSL** : https://www.openssl.org/
- **Binaires Windows (Slproweb)** : https://slproweb.com/products/Win32OpenSSL.html
- **Documentation** : https://www.openssl.org/docs/
- **Wiki Lazarus SSL** : https://wiki.lazarus.freepascal.org/SSL

---

**Prochaine section** : 10.5.2 OpenSSL sur Ubuntu - Installation et configuration Linux

‚è≠Ô∏è [OpenSSL sur Ubuntu](/10-programmation-reseau-avancee/05.2-openssl-ubuntu.md)
